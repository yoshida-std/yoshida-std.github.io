<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <title>Trampoline Pro - Score Pop</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Arial Black', sans-serif; touch-action: none; }
        #game-container { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
        canvas { display: block; background: radial-gradient(circle at 30% 20%, #1a1a2e 0%, #050505 100%); }

        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 50;
        }
        #startBtn {
            padding: 20px 50px; font-size: 30px; color: #fff; background: #00f2fe;
            border: none; border-radius: 50px; cursor: pointer; font-family: 'Arial Black', sans-serif;
            box-shadow: 0 0 20px rgba(0, 242, 254, 0.5);
        }

        .controls { 
            position: absolute; bottom: 0; width: 100%; height: 85px; 
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(20, 20, 40, 0.8); border-top: 2px solid #444; padding: 0 10px; box-sizing: border-box; z-index: 20;
        }
        .btn { 
            width: 48%; height: 65px; background: linear-gradient(#333, #111); 
            border: 2px solid #888; border-radius: 12px; display: flex; 
            justify-content: center; align-items: center; color: #fff; font-size: 28px; user-select: none;
        }

        .info { 
            position: absolute; top: 10px; width: 100%; text-align: center;
            color: #fff; pointer-events: none; z-index: 10;
        }
        #scoreDisplay { font-size: 32px; color: #00f2fe; }
        .next-level { font-size: 14px; color: #ffd700; margin-top: 5px; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="overlay">
        <h1 style="color:#00f2fe; margin-bottom:30px;">TRAMPOLINE JUMP</h1>
        <button id="startBtn">GAME START</button>
    </div>

    <div class="info">
        <div id="scoreDisplay">0</div>
        <div style="font-size: 12px; color: #888;">TOTAL GOALS: <span id="goalCount">0</span> | BALLS: <span id="ballCount">1</span> / 20</div>
        <div class="next-level">NEXT BALL: <span id="levelProgress">0</span> / 5</div>
    </div>
    <canvas id="gameCanvas"></canvas>
    
    <div class="controls">
        <div class="btn" id="leftBtn">LEFT</div>
        <div class="btn" id="rightBtn">RIGHT</div>
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('scoreDisplay');
const goalEl = document.getElementById('goalCount');
const ballCountEl = document.getElementById('ballCount');
const progressEl = document.getElementById('levelProgress');
const overlay = document.getElementById('overlay');
const startBtn = document.getElementById('startBtn');

let isGameRunning = false;
let score = 0;
let totalGoals = 0;
let streakGoals = 0;
let activeBalls = [];
let droppedBalls = [];
let popMessages = [];
let armAngle = 0;

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

const player = {
    x: 0,
    get y() { return canvas.height - 110; },
    w: 140, h: 20, bend: 0, speed: 24
};
player.x = canvas.width / 2 - 70;

function getNewBallData() {
    const launchPoints = [
        { x: 50,  vx: 2.5, vy: -1.5 },
        { x: 120, vx: 2,   vy: -2 },
        { x: 200, vx: 1.5, vy: -5 },
        { x: 280, vx: 0.5, vy: -3 },
        { x: 350, vx: -1,  vy: -2 }
    ];
    const p = launchPoints[Math.floor(Math.random() * launchPoints.length)];
    return {
        originX: p.x, x: p.x, y: 70, radius: 10,
        vx: p.vx, vy: p.vy, gravity: 0.18,
        color: `hsl(${Math.random() * 360}, 80%, 60%)`,
        isWaiting: false
    };
}

function respawnBall(index) {
    activeBalls[index].isWaiting = true;
    setTimeout(() => {
        if (!isGameRunning) return;
        activeBalls[index] = getNewBallData();
        armAngle = Math.PI;
    }, 1200);
}

startBtn.onclick = () => {
    overlay.style.display = 'none';
    isGameRunning = true;
    if(activeBalls.length === 0) activeBalls.push(getNewBallData());
};

let left = false, right = false;
document.getElementById('leftBtn').ontouchstart = (e) => { e.preventDefault(); left = true; };
document.getElementById('leftBtn').ontouchend = () => left = false;
document.getElementById('rightBtn').ontouchstart = (e) => { e.preventDefault(); right = true; };
document.getElementById('rightBtn').ontouchend = () => right = false;

function addPopMessage(text, x, y, color, fontSize = 30) {
    popMessages.push({text, x, y, life: 1.0, color, fontSize});
}

function update() {
    if (!isGameRunning) return;
    if (left && player.x > 0) player.x -= player.speed;
    if (right && player.x < canvas.width - player.w) player.x += player.speed;
    player.bend *= 0.85;

    popMessages.forEach((m, i) => {
        m.y -= 1.5; m.life -= 0.02;
        if (m.life <= 0) popMessages.splice(i, 1);
    });

    activeBalls.forEach((b, i) => {
        if (b.isWaiting) return;

        b.vy += b.gravity; b.x += b.vx; b.y += b.vy;

        if (b.x < b.radius) {
            b.x = b.radius;
            b.vx *= -0.8;
        }

        if (b.y + b.radius > player.y && b.y < player.y + player.h &&
            b.x > player.x && b.x < player.x + player.w && b.vy > 0) {
            player.bend = Math.min(b.vy * 4, 40);
            b.vy *= -1.06;
            b.y = player.y - b.radius;
            b.radius += 3.5;
            score += 1;
            b.vx += (b.x - (player.x + player.w/2)) * 0.08;
        }

        if (b.y > canvas.height - 85 - b.radius) {
            streakGoals = 0;
            addPopMessage("MISS...", b.x, b.y, "#ff4444", 25);
            droppedBalls.push({...b, y: canvas.height - 85 - b.radius});
            respawnBall(i);
        }

        if (b.x > canvas.width + b.radius) {
            const points = Math.floor(b.radius * 10);
            score += points;
            totalGoals++;
            streakGoals++;
            
            // ポイントに応じてサイズを変える (最小30, 最大80程度)
            const dynamicSize = Math.min(30 + (points / 5), 80);
            addPopMessage(`+${points}`, canvas.width - 80, b.y, "#00ff00", dynamicSize);
            
            if (streakGoals >= 5 && activeBalls.length < 20) {
                activeBalls.push({isWaiting: true});
                respawnBall(activeBalls.length - 1);
                addPopMessage("LEVEL UP!", canvas.width / 2, canvas.height / 2, "#ffd700", 50);
                streakGoals = 0;
            } else if (streakGoals >= 5) {
                streakGoals = 0;
            }
            respawnBall(i);
        }
    });
    armAngle *= 0.88;
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = "rgba(0, 242, 254, 0.2)";
    ctx.fillRect(0, 0, 4, canvas.height - 85);

    activeBalls.forEach(b => {
        if (b.isWaiting) return;
        ctx.strokeStyle = "#fff"; ctx.lineWidth = 2;
        const py = 75;
        ctx.beginPath(); ctx.arc(b.originX, py-25, 7, 0, Math.PI*2); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(b.originX, py-18); ctx.lineTo(b.originX, py); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(b.originX, py-14);
        ctx.lineTo(b.originX + Math.cos(armAngle)*20, py-14 + Math.sin(armAngle)*20); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(b.originX, py); ctx.lineTo(b.originX-7, py+12); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(b.originX, py); ctx.lineTo(b.originX+7, py+12); ctx.stroke();
    });

    droppedBalls.forEach(b => {
        ctx.globalAlpha = 0.2; ctx.fillStyle = b.color;
        ctx.beginPath(); ctx.arc(b.x, b.y, b.radius, 0, Math.PI*2); ctx.fill();
    });
    ctx.globalAlpha = 1.0;

    ctx.fillStyle = "#333";
    ctx.fillRect(player.x, player.y, player.w, 10);
    ctx.strokeStyle = "#00f2fe"; ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(player.x + 10, player.y + 5);
    ctx.quadraticCurveTo(player.x + player.w/2, player.y + 5 + player.bend, player.x + player.w - 10, player.y + 5);
    ctx.stroke();
    ctx.fillStyle = "#555";
    ctx.fillRect(player.x + 10, player.y + 10, 6, 10);
    ctx.fillRect(player.x + player.w - 16, player.y + 10, 6, 10);

    activeBalls.forEach(b => {
        if (b.isWaiting) return;
        ctx.shadowBlur = 15; ctx.shadowColor = b.color;
        ctx.fillStyle = b.color;
        ctx.beginPath(); ctx.arc(b.x, b.y, b.radius, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
    });

    popMessages.forEach(m => {
        ctx.globalAlpha = m.life;
        ctx.fillStyle = m.color;
        ctx.font = `bold ${m.fontSize}px Arial`;
        ctx.textAlign = "center";
        // 縁取りを入れて読みやすく
        ctx.strokeStyle = "black";
        ctx.lineWidth = 4;
        ctx.strokeText(m.text, m.x, m.y);
        ctx.fillText(m.text, m.x, m.y);
    });
    ctx.globalAlpha = 1.0;

    scoreEl.innerText = score;
    goalEl.innerText = totalGoals;
    ballCountEl.innerText = activeBalls.filter(b => !b.isWaiting).length;
    progressEl.innerText = streakGoals;
}

function loop() { update(); draw(); requestAnimationFrame(loop); }
loop();
</script>
</body>
</html>
