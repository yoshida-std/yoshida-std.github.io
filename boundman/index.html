<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <title>Trampoline Pro - Result Guard</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Arial Black', sans-serif; touch-action: none; }
        #game-container { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
        canvas { display: block; background: radial-gradient(circle at 30% 20%, #1a1a2e 0%, #050505 100%); }

        /* Á∏¶ÁîªÈù¢Ë≠¶Âëä */
        #orientation-warning {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; color: white; z-index: 100; flex-direction: column; 
            justify-content: center; align-items: center; text-align: center;
        }
        @media (orientation: portrait) { #orientation-warning { display: flex; } }

        /* „Ç™„Éº„Éê„Éº„É¨„Ç§ÂÖ±ÈÄö */
        .full-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 50; color: white;
        }
        #startBtn {
            padding: 20px 50px; font-size: 28px; color: #fff; background: #00f2fe;
            border: none; border-radius: 50px; cursor: pointer; font-family: 'Arial Black', sans-serif;
            box-shadow: 0 0 20px rgba(0, 242, 254, 0.5);
        }

        /* „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÁîªÈù¢Âõ∫Êúâ */
        #gameOverOverlay h1 { color: #ff4444; font-size: 60px; margin: 0; }
        #finalScore { font-size: 48px; color: #ffd700; margin: 20px 0; text-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }
        #retryGuide { font-size: 18px; color: #888; margin-top: 10px; }

        /* ‰∏ãÈÉ®Êìç‰Ωú„Ç®„É™„Ç¢ */
        .controls { 
            position: absolute; bottom: 0; width: 100%; height: 85px; 
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(20, 20, 40, 0.9); border-top: 2px solid #444; padding: 0 10px; box-sizing: border-box; z-index: 20;
        }
        .btn { 
            width: 38%; height: 60px; background: linear-gradient(#333, #111); 
            border: 2px solid #888; border-radius: 12px; display: flex; 
            justify-content: center; align-items: center; color: #fff; font-size: 22px; user-select: none;
        }
        .btn-home { width: 15%; height: 45px; font-size: 22px; background: #222; border-color: #555; }

        .info { 
            position: absolute; top: 10px; width: 100%; text-align: center;
            color: #fff; pointer-events: none; z-index: 10;
        }
        #scoreDisplay { font-size: 30px; color: #00f2fe; }
        #timerDisplay { font-size: 22px; color: #ff4444; }
    </style>
</head>
<body>

<div id="orientation-warning">
    <div style="font-size: 50px;">üîÑ</div>
    <p>ÁîªÈù¢„ÇíÊ®™Âêë„Åç„Å´ÂõûËª¢„Åï„Åõ„Å¶„Åè„Å†„Åï„ÅÑ</p>
</div>

<div id="game-container">
    <div id="overlay" class="full-overlay">
        <h1 style="color:#00f2fe; margin-bottom:10px;">TRAMPOLINE JUMP</h1>
        <p style="color:#888; margin-bottom:30px;">LIMIT: 100 SEC</p>
        <button id="startBtn">GAME START</button>
    </div>

    <div id="gameOverOverlay" class="full-overlay" style="display: none;">
        <h1>TIME UP!</h1>
        <div id="finalScore">Score: 0</div>
        <div id="retryGuide">PLEASE WAIT...</div>
    </div>

    <div class="info">
        <div id="timerDisplay">TIME: 100</div>
        <div id="scoreDisplay">0</div>
        <div style="font-size: 11px; color: #888;">BALLS: <span id="ballCount">1</span> | STREAK: <span id="levelProgress">0</span> / 5</div>
    </div>

    <canvas id="gameCanvas"></canvas>
    
    <div class="controls">
        <div class="btn" id="leftBtn">LEFT</div>
        <div class="btn btn-home" id="homeBtn">üè†</div>
        <div class="btn" id="rightBtn">RIGHT</div>
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('scoreDisplay');
const timerEl = document.getElementById('timerDisplay');
const ballCountEl = document.getElementById('ballCount');
const progressEl = document.getElementById('levelProgress');
const overlay = document.getElementById('overlay');
const gameOverOverlay = document.getElementById('gameOverOverlay');
const finalScoreEl = document.getElementById('finalScore');
const retryGuide = document.getElementById('retryGuide');

let isGameRunning = false;
let canReturnToTitle = false; // „É™„Ç∂„É´„ÉàÁîªÈù¢„ÅßÊàª„Çå„Çã„Åã„Å©„ÅÜ„Åã„ÅÆ„Éï„É©„Ç∞
let score = 0;
let timeLeft = 100;
let timerInterval;
let streakGoals = 0;
let activeBalls = [];
let droppedBalls = [];
let popMessages = [];
let armAngle = 0;

const player = {
    x: 0,
    get y() { return canvas.height - 110; },
    w: 140, h: 20, bend: 0, speed: 24
};

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    player.x = canvas.width / 2 - player.w / 2;
}
window.addEventListener('resize', resize);
resize();

function resetState() {
    score = 0;
    timeLeft = 100;
    streakGoals = 0;
    activeBalls = [];
    droppedBalls = [];
    popMessages = [];
    clearInterval(timerInterval);
    scoreEl.innerText = "0";
    timerEl.innerText = "TIME: 100";
    progressEl.innerText = "0";
    ballCountEl.innerText = "1";
    canReturnToTitle = false;
}

function getNewBallData() {
    const launchPoints = [
        { x: 50, vx: 2.5, vy: -1.5 }, { x: 120, vx: 2, vy: -2 },
        { x: 200, vx: 1.5, vy: -5 }, { x: 280, vx: 0.5, vy: -3 }, { x: 350, vx: -1, vy: -2 }
    ];
    const p = launchPoints[Math.floor(Math.random() * launchPoints.length)];
    return {
        originX: p.x, x: p.x, y: 70, radius: 10,
        vx: p.vx, vy: p.vy, gravity: 0.18,
        color: `hsl(${Math.random() * 360}, 80%, 60%)`,
        isWaiting: false
    };
}

function respawnBall(index) {
    if (!isGameRunning) return;
    activeBalls[index].isWaiting = true;
    setTimeout(() => {
        if (!isGameRunning) return;
        activeBalls[index] = getNewBallData();
        armAngle = Math.PI;
    }, 1200);
}

document.getElementById('startBtn').onclick = () => {
    resetState();
    overlay.style.display = 'none';
    gameOverOverlay.style.display = 'none';
    isGameRunning = true;
    activeBalls.push(getNewBallData());
    timerInterval = setInterval(() => {
        if(isGameRunning) {
            timeLeft--;
            timerEl.innerText = `TIME: ${timeLeft}`;
            if(timeLeft <= 0) endGame();
        }
    }, 1000);
};

document.getElementById('homeBtn').onclick = () => {
    isGameRunning = false;
    resetState();
    overlay.style.display = 'flex';
    gameOverOverlay.style.display = 'none';
};

// „É™„Ç∂„É´„ÉàÁîªÈù¢„Åß„ÅÆ„Çø„ÉÉ„ÉóÂá¶ÁêÜ
gameOverOverlay.onclick = () => {
    if (canReturnToTitle) {
        gameOverOverlay.style.display = 'none';
        overlay.style.display = 'flex';
        resetState();
    }
};

function endGame() {
    isGameRunning = false;
    clearInterval(timerInterval);
    finalScoreEl.innerText = `Score: ${score}`;
    gameOverOverlay.style.display = 'flex';
    
    // Ë™§Êìç‰ΩúÈò≤Ê≠¢Áî®„ÅÆ„ÇØ„Éº„É´„Çø„Ç§„É†Ë®≠ÂÆö
    canReturnToTitle = false;
    retryGuide.innerText = "PLEASE WAIT...";
    retryGuide.style.color = "#888";

    setTimeout(() => {
        canReturnToTitle = true;
        retryGuide.innerText = "TAP TO RETURN";
        retryGuide.style.color = "#00f2fe";
    }, 2000); // 2ÁßíÈñìÂæÖÊ©ü
}

let left = false, right = false;
const inputOpt = { passive: false };
document.getElementById('leftBtn').addEventListener('touchstart', (e) => { e.preventDefault(); left = true; }, inputOpt);
document.getElementById('leftBtn').addEventListener('touchend', () => left = false);
document.getElementById('rightBtn').addEventListener('touchstart', (e) => { e.preventDefault(); right = true; }, inputOpt);
document.getElementById('rightBtn').addEventListener('touchend', () => right = false);

function addPopMessage(text, x, y, color, fontSize = 30) {
    popMessages.push({text, x, y, life: 1.0, color, fontSize});
}

function update() {
    if (!isGameRunning) return;
    if (left && player.x > 0) player.x -= player.speed;
    if (right && player.x < canvas.width - player.w) player.x += player.speed;
    player.bend *= 0.85;

    popMessages.forEach((m, i) => {
        m.y -= 1.5; m.life -= 0.02;
        if (m.life <= 0) popMessages.splice(i, 1);
    });

    activeBalls.forEach((b, i) => {
        if (b.isWaiting) return;
        b.vy += b.gravity; b.x += b.vx; b.y += b.vy;

        if (b.x < b.radius) { b.x = b.radius; b.vx *= -0.8; }

        if (b.y + b.radius > player.y && b.y < player.y + player.h &&
            b.x > player.x && b.x < player.x + player.w && b.vy > 0) {
            player.bend = Math.min(b.vy * 4, 40);
            b.vy *= -1.06; b.y = player.y - b.radius;
            b.radius += 3.5; score += 1;
            b.vx += (b.x - (player.x + player.w/2)) * 0.08;
        }

        if (b.y > canvas.height - 85 - b.radius) {
            streakGoals = 0;
            addPopMessage("MISS...", b.x, b.y, "#ff4444", 25);
            droppedBalls.push({...b, y: canvas.height - 85 - b.radius});
            respawnBall(i);
        }

        if (b.x > canvas.width + b.radius) {
            const points = Math.floor(b.radius * 10);
            score += points;
            streakGoals++;
            const dynamicSize = Math.min(30 + (points / 5), 80);
            addPopMessage(`+${points}`, canvas.width - 80, b.y, "#00ff00", dynamicSize);
            
            if (streakGoals >= 5 && activeBalls.length < 20) {
                activeBalls.push({isWaiting: true});
                respawnBall(activeBalls.length - 1);
                addPopMessage("LEVEL UP!", canvas.width / 2, canvas.height / 2, "#ffd700", 45);
                streakGoals = 0;
            } else if (streakGoals >= 5) streakGoals = 0;
            respawnBall(i);
        }
    });
    armAngle *= 0.88;
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "rgba(0, 242, 254, 0.2)";
    ctx.fillRect(0, 0, 4, canvas.height - 85);

    activeBalls.forEach(b => {
        if (b.isWaiting) return;
        const px = b.originX, py = 75;
        ctx.strokeStyle = "#fff"; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.arc(px, py-25, 7, 0, Math.PI*2); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(px, py-18); ctx.lineTo(px, py); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(px, py-14);
        ctx.lineTo(px + Math.cos(armAngle)*20, py-14 + Math.sin(armAngle)*20); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(px, py); ctx.lineTo(px-7, py+12); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(px, py); ctx.lineTo(px+7, py+12); ctx.stroke();
    });

    droppedBalls.forEach(b => {
        ctx.globalAlpha = 0.2; ctx.fillStyle = b.color;
        ctx.beginPath(); ctx.arc(b.x, b.y, b.radius, 0, Math.PI*2); ctx.fill();
    });
    ctx.globalAlpha = 1.0;

    // „Éà„É©„É≥„Éù„É™„É≥
    ctx.fillStyle = "#333";
    ctx.fillRect(player.x, player.y, player.w, 10);
    ctx.strokeStyle = "#00f2fe"; ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(player.x + 10, player.y + 5);
    ctx.quadraticCurveTo(player.x + player.w/2, player.y + 5 + player.bend, player.x + player.w - 10, player.y + 5);
    ctx.stroke();

    activeBalls.forEach(b => {
        if (b.isWaiting) return;
        ctx.shadowBlur = 15; ctx.shadowColor = b.color;
        ctx.fillStyle = b.color;
        ctx.beginPath(); ctx.arc(b.x, b.y, b.radius, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
    });

    popMessages.forEach(m => {
        ctx.globalAlpha = m.life;
        ctx.fillStyle = m.color;
        ctx.font = `bold ${m.fontSize}px Arial`; ctx.textAlign = "center";
        ctx.strokeStyle = "black"; ctx.lineWidth = 4;
        ctx.strokeText(m.text, m.x, m.y);
        ctx.fillText(m.text, m.x, m.y);
    });
    ctx.globalAlpha = 1.0;

    scoreEl.innerText = score;
    ballCountEl.innerText = activeBalls.filter(b => !b.isWaiting).length;
    progressEl.innerText = streakGoals;
}

function loop() { update(); draw(); requestAnimationFrame(loop); }
loop();
</script>
</body>
</html>
