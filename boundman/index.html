<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trampoline Bottom Controls</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Arial Black', sans-serif; touch-action: none; }
        
        /* ゲーム画面 */
        #game-container { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
        canvas { display: block; background: radial-gradient(circle at 30% 20%, #16213e 0%, #050505 100%); }

        /* 下部ボタンエリア */
        .controls { 
            position: absolute; bottom: 0; width: 100%; height: 100px; 
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px);
            padding: 0 20px; box-sizing: border-box; z-index: 20;
        }
        .btn { 
            width: 45%; height: 70px; background: rgba(0, 242, 254, 0.1); 
            border: 3px solid #00f2fe; border-radius: 10px; 
            display: flex; justify-content: center; align-items: center; 
            color: #00f2fe; font-size: 40px; user-select: none;
        }
        .btn:active { background: #00f2fe; color: #000; }

        .info { 
            position: absolute; top: 15px; width: 100%; text-align: center;
            color: #fff; pointer-events: none; z-index: 10;
        }
        #scoreDisplay { font-size: 32px; text-shadow: 0 0 10px #00f2fe; }
    </style>
</head>
<body>

<div id="game-container">
    <div class="info">
        <div id="scoreDisplay">0</div>
        <div style="font-size: 12px; color: #aaa;">GOALS: <span id="goalCount">0</span> | BALLS: <span id="ballCount">1</span></div>
    </div>
    <canvas id="gameCanvas"></canvas>

    <div class="controls">
        <div class="btn" id="leftBtn">←</div>
        <div class="btn" id="rightBtn">→</div>
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('scoreDisplay');
const goalEl = document.getElementById('goalCount');
const ballCountEl = document.getElementById('ballCount');

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

let score = 0;
let goals = 0;
let activeBalls = [];
let droppedBalls = [];
let armAngle = 0;

// トランポリンをさらに下（ボタンエリアのすぐ上）に配置
const player = {
    x: canvas.width / 2 - 65,
    y: canvas.height - 130, // 下部ボタン100px + 余裕30px
    w: 130,
    h: 12,
    bend: 0,
    speed: 16
};

const patterns = [
    {vx: 2.5, vy: -1.5}, // 普通
    {vx: 5.0, vy: 0.5},  // 速くて低い
    {vx: 1.5, vy: -7.0}  // 高い放物線
];

function createBall() {
    const p = patterns[Math.floor(Math.random() * patterns.length)];
    armAngle = Math.PI;
    return {
        x: 50, y: 80,
        radius: 12,
        vx: p.vx, vy: p.vy,
        gravity: 0.25,
        color: `hsl(${Math.random() * 360}, 80%, 60%)`
    };
}

activeBalls.push(createBall());

let left = false, right = false;
document.getElementById('leftBtn').ontouchstart = (e) => { e.preventDefault(); left = true; };
document.getElementById('leftBtn').ontouchend = () => left = false;
document.getElementById('rightBtn').ontouchstart = (e) => { e.preventDefault(); right = true; };
document.getElementById('rightBtn').ontouchend = () => right = false;

function drawPerson() {
    ctx.strokeStyle = "#fff"; ctx.lineWidth = 3;
    const px = 40, py = 80;
    ctx.beginPath(); ctx.arc(px, py-30, 8, 0, Math.PI*2); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(px, py-22); ctx.lineTo(px, py); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(px, py-18);
    ctx.lineTo(px + Math.cos(armAngle)*22, py-18 + Math.sin(armAngle)*22); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(px, py); ctx.lineTo(px-10, py+15); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(px, py); ctx.lineTo(px+10, py+15); ctx.stroke();
    armAngle *= 0.88;
}

function update() {
    if (left && player.x > 0) player.x -= player.speed;
    if (right && player.x < canvas.width - player.w) player.x += player.speed;
    player.bend *= 0.82;

    for (let i = activeBalls.length - 1; i >= 0; i--) {
        let b = activeBalls[i];
        b.vy += b.gravity; b.x += b.vx; b.y += b.vy;

        // トランポリン衝突判定
        if (b.y + b.radius > player.y + player.bend && b.y < player.y + player.h + 20 &&
            b.x > player.x && b.x < player.x + player.w && b.vy > 0) {
            
            player.bend = Math.min(b.vy * 4, 35);
            b.vy *= -1.18; 
            b.y = player.y - b.radius;
            b.radius += 4; 
            score += 1;
            b.vx += (b.x - (player.x + player.w/2)) * 0.12;
        }

        // 地面に落下（ボタンエリアの上端）
        if (b.y > canvas.height - 100 - b.radius) {
            b.y = canvas.height - 100 - b.radius;
            droppedBalls.push({...b});
            if (activeBalls.length > 1) activeBalls.splice(i, 1);
            else activeBalls[i] = createBall();
        }

        // 右端ゴール
        if (b.x > canvas.width + b.radius) {
            score += Math.floor(b.radius * 10);
            goals++;
            if (goals % 5 === 0) activeBalls.push(createBall());
            activeBalls[i] = createBall();
        }
    }
    scoreEl.innerText = score;
    goalEl.innerText = goals;
    ballCountEl.innerText = activeBalls.length;
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawPerson();

    // 地面の玉（ボタンエリアの上に積み重なる）
    droppedBalls.forEach(b => {
        ctx.globalAlpha = 0.4; ctx.fillStyle = b.color;
        ctx.beginPath(); ctx.arc(b.x, b.y, b.radius, 0, Math.PI*2); ctx.fill();
    });
    ctx.globalAlpha = 1.0;

    // トランポリン
    ctx.strokeStyle = "#00f2fe"; ctx.lineWidth = 5;
    ctx.lineCap = "round";
    ctx.beginPath();
    ctx.moveTo(player.x, player.y);
    ctx.quadraticCurveTo(player.x + player.w/2, player.y + player.bend*2, player.x + player.w, player.y);
    ctx.stroke();
    // 支柱
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(player.x+10, player.y); ctx.lineTo(player.x+10, player.y+25);
    ctx.moveTo(player.x+player.w-10, player.y); ctx.lineTo(player.x+player.w-10, player.y+25);
    ctx.stroke();

    // アクティブな玉
    activeBalls.forEach(b => {
        ctx.shadowBlur = 15; ctx.shadowColor = b.color;
        ctx.fillStyle = b.color;
        ctx.beginPath(); ctx.arc(b.x, b.y, b.radius, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
        ctx.fillStyle = "#fff"; ctx.font = "bold 14px Arial"; ctx.textAlign = "center";
        ctx.fillText(`+${Math.floor(b.radius*10)}`, b.x, b.y - b.radius - 8);
    });
}

function loop() { update(); draw(); requestAnimationFrame(loop); }
loop();
</script>
</body>
</html>
